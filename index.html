<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚öì Jordan's Sailboat Financial Planner</title>
<style>
  :root {
    --bg: #080e1a;
    --card: #0f1e35;
    --border: rgba(59,157,232,0.18);
    --accent: #3b9de8;
    --text: #dde8f5;
    --muted: #7a96b8;
    --green: #2ecc71;
    --amber: #f0a500;
    --red: #e05555;
    --r: 10px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    font-size: 14px;
    line-height: 1.5;
  }

  /* HEADER */
  header {
    background: linear-gradient(160deg, #0a1a30 0%, #091422 100%);
    border-bottom: 1px solid var(--border);
    padding: 28px 24px 20px;
    text-align: center;
  }
  header h1 { font-size: 22px; font-weight: 700; letter-spacing: -0.3px; }
  header p { color: var(--muted); font-size: 13px; margin-top: 4px; }

  /* STICKY BAR */
  .bar {
    position: sticky; top: 0; z-index: 50;
    background: rgba(9,20,34,0.92);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border);
    display: flex; flex-wrap: wrap;
    justify-content: center; gap: 0;
  }
  .bar-item {
    padding: 12px 20px;
    text-align: center;
    border-right: 1px solid var(--border);
    min-width: 140px;
  }
  .bar-item:last-child { border-right: none; }
  .bar-item .lbl { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); }
  .bar-item .val { font-size: 16px; font-weight: 700; color: var(--accent); margin-top: 2px; }
  .val.g { color: var(--green); }
  .val.a { color: var(--amber); }
  .val.r { color: var(--red); }

  /* LAYOUT */
  .page { max-width: 1200px; margin: 0 auto; padding: 20px 16px 40px; }
  .cols { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media(max-width: 880px) { .cols { grid-template-columns: 1fr; } }
  .full { grid-column: 1 / -1; }

  /* CARD */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 18px;
    margin-bottom: 16px;
  }
  .card:last-child { margin-bottom: 0; }
  .section { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); margin-bottom: 14px; }

  /* INPUTS */
  .field { margin-bottom: 14px; }
  .field label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 5px; }
  .slider-row { display: flex; align-items: center; gap: 10px; }
  input[type=range] {
    flex: 1; height: 4px; -webkit-appearance: none;
    background: rgba(59,157,232,0.2); border-radius: 2px; outline: none; cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 16px; height: 16px;
    background: var(--accent); border-radius: 50%; cursor: pointer;
  }
  .num-input {
    width: 110px; text-align: right;
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--border); border-radius: 7px;
    color: var(--text); font-size: 14px; font-weight: 600;
    padding: 6px 10px;
  }
  .num-input:focus { outline: none; border-color: var(--accent); }

  /* TABS */
  .tabs { display: flex; gap: 4px; margin-bottom: 14px; flex-wrap: wrap; }
  .tab {
    flex: 1; padding: 10px 6px; text-align: center;
    background: transparent; border: 1px solid var(--border); border-radius: 7px;
    color: var(--muted); font-size: 11px; font-weight: 500; cursor: pointer;
    transition: all 0.15s; min-width: 120px;
  }
  .tab:hover { border-color: var(--accent); color: var(--text); }
  .tab.on { background: rgba(59,157,232,0.15); border-color: var(--accent); color: var(--accent); font-weight: 700; }

  /* SELECT */
  select {
    width: 100%; background: rgba(255,255,255,0.05);
    border: 1px solid var(--border); border-radius: 7px;
    color: var(--text); font-size: 13px; padding: 7px 10px; outline: none; cursor: pointer;
  }
  select:focus { border-color: var(--accent); }

  /* ADDON LIST */
  .addon {
    display: flex; align-items: center; justify-content: space-between;
    padding: 7px 8px; border-radius: 6px; cursor: pointer;
    transition: background 0.1s;
  }
  .addon:hover { background: rgba(255,255,255,0.04); }
  .addon input { accent-color: var(--accent); margin-right: 8px; cursor: pointer; }
  .addon .aname { font-size: 12px; color: var(--text); }
  .addon .acost { font-size: 12px; color: var(--muted); font-weight: 600; }

  /* BUDGET ROWS */
  .brow { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 13px; }
  .brow:last-child { border-bottom: none; }
  .brow .bc { color: var(--muted); }
  .brow .ba { color: var(--text); font-weight: 500; }
  .btotal { display: flex; justify-content: space-between; align-items: baseline; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
  .btotal .bl { font-size: 13px; color: var(--muted); }
  .btotal .bv { font-size: 20px; font-weight: 700; color: var(--accent); }

  /* DIVIDER */
  .div { height: 1px; background: var(--border); margin: 14px 0; }

  /* SPLIT DISPLAY */
  .split { display: flex; gap: 16px; }
  .split > div { flex: 1; }
  .split-item { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
  .split-item h4 { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); margin-bottom: 6px; }
  .split-value { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
  .split-sub { font-size: 11px; color: var(--muted); }

  /* SCENARIO BOX */
  .scenario {
    background: rgba(240,165,0,0.07);
    border: 1px solid rgba(240,165,0,0.2);
    border-radius: 8px; padding: 14px; margin-top: 12px;
  }
  .scenario h4 { font-size: 12px; color: var(--amber); margin-bottom: 8px; font-weight: 600; }
  .scenario-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
  .scenario-row:last-child { margin-bottom: 0; }

  /* TARGET ROWS */
  .trow { display: flex; justify-content: space-between; font-size: 13px; padding: 4px 0; }
  .trow .tc { color: var(--muted); }
  .trow .tv { color: var(--text); font-weight: 500; }
  .trow.total { padding-top: 8px; margin-top: 6px; border-top: 1px solid var(--border); }
  .trow.total .tc { color: var(--text); font-weight: 600; }
  .trow.total .tv { color: var(--accent); font-weight: 700; font-size: 16px; }

  /* PROGRESS */
  .prog-meta { display: flex; justify-content: space-between; font-size: 11px; color: var(--muted); margin-bottom: 4px; }
  .prog-bar { height: 7px; background: rgba(255,255,255,0.07); border-radius: 4px; overflow: hidden; }
  .prog-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
  .prog-sub { display: flex; justify-content: space-between; font-size: 11px; color: var(--muted); margin-top: 4px; }

  /* CHECKS */
  .check {
    display: flex; gap: 10px; align-items: flex-start;
    padding: 11px 12px; border-radius: 8px; margin-bottom: 8px;
    border: 1px solid transparent;
  }
  .check.p { background: rgba(46,204,113,0.07); border-color: rgba(46,204,113,0.2); }
  .check.w { background: rgba(240,165,0,0.07); border-color: rgba(240,165,0,0.2); }
  .check.f { background: rgba(224,85,85,0.07); border-color: rgba(224,85,85,0.2); }
  .check-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
  .check-title { font-size: 13px; font-weight: 600; color: var(--text); }
  .check-detail { font-size: 12px; color: var(--muted); margin-top: 2px; }

  /* CHECKBOX AREAS */
  .check-group { margin-bottom: 16px; }
  .check-group h4 { font-size: 12px; color: var(--accent); margin-bottom: 8px; font-weight: 600; }
  .skill-check {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 8px; margin-bottom: 4px;
    border-radius: 6px; cursor: pointer;
    transition: background 0.1s;
  }
  .skill-check:hover { background: rgba(255,255,255,0.04); }
  .skill-check input { accent-color: var(--accent); cursor: pointer; }
  .skill-check label { font-size: 12px; color: var(--text); cursor: pointer; flex: 1; }

  /* TIMELINE BOX */
  .tbox {
    background: rgba(59,157,232,0.07);
    border: 1px solid rgba(59,157,232,0.2);
    border-radius: 9px; padding: 16px;
    display: flex; flex-wrap: wrap; gap: 24px;
    margin-top: 16px;
  }
  .tbox-item .tlbl { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); margin-bottom: 3px; }
  .tbox-item .tval { font-size: 18px; font-weight: 700; color: var(--accent); }
  .tbox-item .tsub { font-size: 11px; color: var(--muted); margin-top: 2px; }

  /* COLLAPSIBLE SECTIONS */
  .collapsible {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--r);
    margin-top: 16px;
    overflow: hidden;
  }
  .collapsible-header {
    padding: 14px 18px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.15s;
  }
  .collapsible-header:hover { background: rgba(255,255,255,0.03); }
  .collapsible-content {
    padding: 0 18px 18px;
    display: none;
  }
  .collapsible-content.open { display: block; }
  .collapsible-icon {
    transition: transform 0.2s;
    font-size: 14px;
    color: var(--accent);
  }
  .collapsible-icon.open { transform: rotate(180deg); }

  /* BALANCE SHEET */
  .balance-item {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
  }
  .balance-item h4 {
    font-size: 12px;
    color: var(--text);
    margin-bottom: 8px;
    font-weight: 600;
  }
  .balance-note {
    font-size: 10px;
    color: var(--muted);
    margin-top: 4px;
  }

  /* WARNINGS */
  .warning {
    background: rgba(224,85,85,0.07);
    border: 1px solid rgba(224,85,85,0.2);
    border-radius: 8px;
    padding: 12px;
    margin-top: 8px;
  }
  .warning.moderate {
    background: rgba(240,165,0,0.07);
    border-color: rgba(240,165,0,0.2);
  }
  .warning.low {
    background: rgba(46,204,113,0.07);
    border-color: rgba(46,204,113,0.2);
  }

  /* CONCENTRATION RISK */
  .concentration-warning {
    margin-top: 8px;
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 12px;
  }

  /* SF COST OFFSET */
  .sf-offset {
    background: rgba(59,157,232,0.07);
    border: 1px solid rgba(59,157,232,0.2);
    border-radius: 8px;
    padding: 14px;
    margin-top: 12px;
  }
  .sf-offset h4 {
    font-size: 12px;
    color: var(--accent);
    margin-bottom: 8px;
    font-weight: 600;
  }

  /* REVERSE CALCULATOR */
  .reverse-calc {
    background: rgba(240,165,0,0.07);
    border: 1px solid rgba(240,165,0,0.2);
    border-radius: 8px;
    padding: 14px;
    margin-bottom: 16px;
  }
  .reverse-calc h4 {
    font-size: 12px;
    color: var(--amber);
    margin-bottom: 8px;
    font-weight: 600;
  }

  footer { text-align: center; padding: 20px; font-size: 11px; color: var(--muted); border-top: 1px solid var(--border); }
  
  @media(max-width: 680px) {
    .bar { flex-direction: column; }
    .bar-item { border-right: none; border-bottom: 1px solid var(--border); }
    .bar-item:last-child { border-bottom: none; }
    .split { flex-direction: column; }
    .tabs { flex-direction: column; }
    .tab { min-width: auto; }
  }
</style>
</head>
<body>

<header>
  <div style="font-size:28px;margin-bottom:6px">‚öì</div>
  <h1>Jordan's Sailboat Financial Planner</h1>
  <p>Your personal path to blue water cruising</p>
</header>

<div class="bar">
  <div class="bar-item"><div class="lbl">All-In Cost</div><div class="val" id="s-purchase">‚Äî</div></div>
  <div class="bar-item"><div class="lbl">Monthly Burn</div><div class="val" id="s-monthly">‚Äî</div></div>
  <div class="bar-item"><div class="lbl">Gross Income Needed</div><div class="val" id="s-gross">‚Äî</div></div>
  <div class="bar-item"><div class="lbl">Months to Ready</div><div class="val" id="s-timeline">‚Äî</div></div>
  <div class="bar-item"><div class="lbl">Recurring Coverage</div><div class="val" id="s-recurring">‚Äî</div></div>
</div>

<div class="page">
  <div class="cols">

    <!-- LEFT COLUMN -->
    <div>
      <!-- Your Boat -->
      <div class="card">
        <div class="section">Section 1: Your Boat</div>
        <div class="field">
          <label>Boat Selection</label>
          <select id="boat-sel" onchange="selectBoat()">
            <option value="sp-cruiser">Island Packet SP Cruiser ($199k‚Äì$254k)</option>
            <option value="ip420">Island Packet 420 ($180k‚Äì$280k)</option>
            <option value="ip440">Island Packet 440 ($250k‚Äì$380k)</option>
            <option value="leopard40">Leopard 40 ($200k‚Äì$350k)</option>
            <option value="custom">Custom (enter your own)</option>
          </select>
        </div>
        <div class="field">
          <label>Boat Purchase Price</label>
          <div class="slider-row">
            <input type="range" id="boat-r" min="150000" max="400000" step="5000" value="225000">
            <input class="num-input" id="boat-i" value="$225,000">
          </div>
        </div>
        
        <div class="div"></div>
        <div class="section" style="color:var(--accent)">Finance vs Cash</div>
        <div class="tabs" style="margin-bottom:14px">
          <button class="tab on" onclick="setPaymentMethod('cash')">üí∞ Pay Cash</button>
          <button class="tab" onclick="setPaymentMethod('finance')">üè¶ Finance</button>
        </div>
        
        <div id="financing-inputs" style="display:none">
          <div class="field">
            <label>Down Payment</label>
            <div class="slider-row">
              <input type="range" id="down-r" min="10" max="50" step="5" value="20">
              <span class="num-input" style="width:60px" id="down-i">20%</span>
            </div>
          </div>
          <div class="field">
            <label>Interest Rate (current marine loan rates)</label>
            <div class="slider-row">
              <input type="range" id="rate-interest-r" min="4" max="15" step="0.25" value="7.5">
              <span class="num-input" style="width:70px" id="rate-interest-i">7.5%</span>
            </div>
          </div>
          <div class="field">
            <label>Loan Term</label>
            <select id="loan-term" onchange="state.loanTermYears=parseInt(this.value);update()">
              <option value="10">10 years</option>
              <option value="15" selected>15 years</option>
              <option value="20">20 years</option>
            </select>
          </div>
        </div>
        
        <div id="finance-comparison" style="display:none;margin-top:16px">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
            <div class="split-item">
              <h4>üí∞ Pay Cash</h4>
              <div style="font-size:12px;color:var(--muted);margin-bottom:8px">
                <div style="display:flex;justify-content:space-between"><span>Savings needed:</span><span id="cash-savings-needed">‚Äî</span></div>
                <div style="display:flex;justify-content:space-between"><span>Monthly burn:</span><span id="cash-monthly-burn">‚Äî</span></div>
                <div style="display:flex;justify-content:space-between"><span>Months to ready:</span><span id="cash-months-ready">‚Äî</span></div>
                <div style="display:flex;justify-content:space-between"><span>Total boat cost:</span><span id="cash-total-cost">‚Äî</span></div>
                <div style="display:flex;justify-content:space-between"><span>Total interest:</span><span style="color:var(--green)">$0</span></div>
              </div>
            </div>
            <div class="split-item">
              <h4>üè¶ Finance</h4>
              <div style="font-size:12px;color:var(--muted);margin-bottom:8px">
                <div style="display:flex;justify-content:space-between"><span>Savings needed:</span><span id="finance-savings-needed">‚Äî</span></div>
                <div style="display:flex;justify-content:space-between"><span>Monthly burn:</span><span id="finance-monthly-burn">‚Äî</span></div>
                <div style="display:flex;justify-content:space-between"><span>Months to ready:</span><span id="finance-months-ready">‚Äî</span></div>
                <div style="display:flex;justify-content:space-between"><span>Total boat cost:</span><span id="finance-total-cost">‚Äî</span></div>
                <div style="display:flex;justify-content:space-between"><span>Total interest:</span><span id="finance-interest-paid" style="color:var(--amber)">‚Äî</span></div>
              </div>
              <div style="background:rgba(59,157,232,0.1);border-radius:6px;padding:8px;margin-top:8px">
                <div style="font-size:11px;color:var(--muted);margin-bottom:2px">Monthly loan payment</div>
                <div style="font-size:16px;font-weight:700;color:var(--accent)" id="monthly-payment">‚Äî</div>
              </div>
            </div>
          </div>
          
          <div id="finance-insight" style="background:rgba(240,165,0,0.1);border:1px solid rgba(240,165,0,0.3);border-radius:8px;padding:12px;margin-bottom:12px;text-align:center">
            <div style="font-size:13px;font-weight:600;color:var(--amber)" id="insight-text">‚Äî</div>
          </div>
          
          <div style="background:rgba(255,255,255,0.03);border-radius:6px;padding:10px;margin-bottom:12px">
            <div style="font-size:11px;color:var(--muted);line-height:1.4">
              <strong>üí° Opportunity cost:</strong> Cash tied up in the boat can't be invested. At 7% market return, $200k invested over 10 years = $393k. Factor this into your decision.
            </div>
          </div>
          
          <div style="background:rgba(59,157,232,0.07);border:1px solid rgba(59,157,232,0.2);border-radius:8px;padding:12px">
            <div style="font-size:12px;color:var(--text);line-height:1.4">
              <strong>üéØ Guidance:</strong> Finance if you have enough for down payment + expenses + emergency fund, and the monthly payment is covered by recurring income alone. Pay cash if you have the full amount AND keeping the loan payment would make your recurring income insufficient to sustain the lifestyle. The real question is not "can I afford the payment" but "which path gets me on the water sooner with a sustainable income structure."
            </div>
          </div>
        </div>
        
        <!-- FEATURE 6: Boat Resale Value -->
        <div class="collapsible">
          <div class="collapsible-header" onclick="toggleCollapsible('resale')">
            <span style="font-size:12px;color:var(--accent);font-weight:600">üîÑ Boat Resale Value & True Net Cost</span>
            <span class="collapsible-icon" id="resale-icon">‚ñº</span>
          </div>
          <div class="collapsible-content" id="resale-content">
            <div class="field">
              <label>Years before selling</label>
              <div class="slider-row">
                <input type="range" id="years-selling-r" min="3" max="20" step="1" value="7" oninput="updateYearsSelling()">
                <span class="num-input" style="width:60px" id="years-selling-i">7</span>
              </div>
            </div>
            <div class="field">
              <label>Value retention rate (% after 10 years)</label>
              <div class="slider-row">
                <input type="range" id="retention-rate-r" min="50" max="90" step="1" value="72" oninput="updateRetentionRate()">
                <span class="num-input" style="width:60px" id="retention-rate-i">72%</span>
              </div>
              <div style="font-size:11px;color:var(--muted);margin-top:4px">
                IP boats: 72% (hold value well), Leopard 40: 60%, Custom: adjustable
              </div>
            </div>
            <div class="div"></div>
            <div class="trow"><span class="tc">Estimated resale value in <span id="resale-years">7</span> years</span><span class="tv" id="resale-value">‚Äî</span></div>
            <div class="trow"><span class="tc">Net cost of boat ownership</span><span class="tv" id="net-boat-cost">‚Äî</span></div>
            <div class="trow"><span class="tc">Annualized true boat cost</span><span class="tv" id="annualized-cost">‚Äî</span></div>
            <div style="font-size:11px;color:var(--muted);margin-top:8px;text-align:center">
              Compare to rent: $3,200/mo √ó 12 √ó <span id="rent-years">7</span> years = <span id="rent-comparison">‚Äî</span> in rent with nothing to show
            </div>
          </div>
        </div>
        
        <div class="div"></div>
        <div class="section" style="color:var(--muted)">Add-On Costs (toggle to include)</div>
        <div id="addon-list"></div>
        <div class="div"></div>
        <div style="display:flex;justify-content:space-between;align-items:baseline">
          <span style="font-size:13px;color:var(--muted)">Total All-In Cost</span>
          <span style="font-size:20px;font-weight:700;color:var(--accent)" id="purchase-total">‚Äî</span>
        </div>
      </div>

      <!-- Your Numbers -->
      <div class="card">
        <div class="section">Section 3: Your Numbers</div>
        
        <!-- FEATURE 4: Client Concentration Risk -->
        <div class="section" style="color:var(--muted);font-size:12px;margin-bottom:12px">Income Structure</div>
        <div class="field">
          <label>Annual Income</label>
          <div class="slider-row">
            <input type="range" id="income-r" min="100000" max="2000000" step="10000" value="500000">
            <input class="num-input" id="income-i" value="$500,000">
          </div>
        </div>
        <div class="field">
          <label>% of Income that's Recurring/Retainer (vs Project Work)</label>
          <div class="slider-row">
            <input type="range" id="recurring-r" min="0" max="100" step="5" value="60">
            <span class="num-input" style="width:60px" id="recurring-i">60%</span>
          </div>
        </div>
        <div class="field">
          <label>% of income from your top client</label>
          <div class="slider-row">
            <input type="range" id="concentration-r" min="0" max="100" step="5" value="60" oninput="updateConcentration()">
            <span class="num-input" style="width:60px" id="concentration-i">60%</span>
          </div>
          <div id="concentration-warning" class="concentration-warning">
            <!-- Populated by JavaScript -->
          </div>
        </div>
        
        <div class="div"></div>
        
        <!-- FEATURE 1: Personal Balance Sheet -->
        <div class="section" style="color:var(--muted);font-size:12px;margin-bottom:12px">Personal Balance Sheet</div>
        
        <div class="balance-item">
          <h4>üí∞ Liquid Savings (checking, money market)</h4>
          <div class="slider-row">
            <input type="range" id="liquid-r" min="0" max="500000" step="5000" value="50000" oninput="updateLiquid()">
            <input class="num-input" id="liquid-i" value="$50,000">
          </div>
          <div class="balance-note">Fully counts toward purchase</div>
        </div>
        
        <div class="balance-item">
          <h4>üìà Taxable Brokerage</h4>
          <div class="slider-row">
            <input type="range" id="brokerage-r" min="0" max="500000" step="5000" value="50000" oninput="updateBrokerage()">
            <input class="num-input" id="brokerage-i" value="$50,000">
          </div>
          <div class="balance-note">Counts toward purchase (may have capital gains tax on withdrawal)</div>
        </div>
        
        <div class="balance-item">
          <h4>üö® IRA / Roth IRA ‚Äî Emergency backstop only</h4>
          <div class="slider-row">
            <input type="range" id="ira-r" min="0" max="500000" step="5000" value="50000" oninput="updateIRA()">
            <input class="num-input" id="ira-i" value="$50,000">
          </div>
          <div class="balance-note">After 10% penalty + 25% income tax = nets ~$65 on every $100</div>
          <div class="balance-note" style="color:var(--amber);margin-top:4px">IRA net value if accessed early: <span id="ira-net">‚Äî</span></div>
        </div>
        
        <div class="balance-item">
          <h4>üõ°Ô∏è 401k / Other Retirement ‚Äî Don't count this</h4>
          <div class="slider-row">
            <input type="range" id="retirement-r" min="0" max="1000000" step="10000" value="0" oninput="updateRetirement()">
            <input class="num-input" id="retirement-i" value="$0">
          </div>
          <div class="balance-note">Purely for context ‚Äî protected retirement funds</div>
        </div>
        
        <div class="balance-item">
          <h4>üöó Other Assets (car, etc.)</h4>
          <div class="slider-row">
            <input type="range" id="other-assets-r" min="0" max="200000" step="5000" value="0" oninput="updateOtherAssets()">
            <input class="num-input" id="other-assets-i" value="$0">
          </div>
          <div class="balance-note">Additional liquid assets you could sell if needed</div>
        </div>
        
        <div class="div"></div>
        <div class="split">
          <div class="split-item">
            <h4>Available for Purchase</h4>
            <div class="split-value" style="color:var(--green)" id="available-purchase">‚Äî</div>
            <div class="split-sub">Liquid + Brokerage</div>
          </div>
          <div class="split-item">
            <h4>Emergency Backstop</h4>
            <div class="split-value" style="color:var(--amber)" id="emergency-backstop">‚Äî</div>
            <div class="split-sub">IRA net after penalties</div>
          </div>
        </div>
        
        <div class="field">
          <label>Monthly Savings Rate</label>
          <div class="slider-row">
            <input type="range" id="rate-r" min="0" max="50000" step="1000" value="15000">
            <input class="num-input" id="rate-i" value="$15,000">
          </div>
        </div>
        
        <div class="div"></div>
        <div class="field">
          <label>Effective Tax Rate (US citizen, worldwide income)</label>
          <div class="slider-row">
            <input type="range" id="tax-r" min="15" max="50" step="1" value="38">
            <span class="num-input" style="width:60px" id="tax-i">38%</span>
          </div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">
            Federal (~22-24%) + self-employment tax net (~8%) + state. Self-employed consultant estimate.
          </div>
        </div>

        <div style="background:rgba(59,157,232,0.07);border:1px solid rgba(59,157,232,0.2);border-radius:8px;padding:12px;margin-top:12px;">
          <h4 style="font-size:12px;color:var(--accent);margin-bottom:8px;font-weight:600;">üí° Tax Planning Notes</h4>
          <div style="font-size:11px;color:var(--muted);line-height:1.4;">
            <div style="margin-bottom:6px;">
              <strong>FEIE (Foreign Earned Income Exclusion):</strong> If qualifying (330+ days outside US), can exclude ~$126,500 from federal tax. Could reduce effective rate significantly.
            </div>
            <div>
              <strong>California Residency:</strong> CA attempts to tax former residents on worldwide income. Formal domicile severance needed before departure.
            </div>
          </div>
        </div>
        
        <div class="div"></div>
        <div class="split">
          <div class="split-item">
            <h4>Recurring Income</h4>
            <div class="split-value" style="color:var(--green)" id="recurring-amt">‚Äî</div>
            <div class="split-sub">Retainer work</div>
          </div>
          <div class="split-item">
            <h4>Project Income</h4>
            <div class="split-value" style="color:var(--amber)" id="project-amt">‚Äî</div>
            <div class="split-sub">Variable work</div>
          </div>
        </div>

        <div class="scenario">
          <h4>‚ö†Ô∏è "50% Income Drop" Scenario</h4>
          <div class="scenario-row">
            <span>If one major retainer falls apart:</span>
            <span id="drop-income">‚Äî</span>
          </div>
          <div class="scenario-row">
            <span>Monthly runway (after tax + expenses):</span>
            <span id="runway-months">‚Äî</span>
          </div>
        </div>
        
        <div id="concentration-scenario" class="scenario" style="display:none;">
          <h4>‚ö†Ô∏è "Top Client Leaves" Scenario</h4>
          <div class="scenario-row">
            <span>Monthly income drops to:</span>
            <span id="post-client-loss-income">‚Äî</span>
          </div>
          <div class="scenario-row">
            <span>Runway with remaining income:</span>
            <span id="client-loss-runway">‚Äî</span>
          </div>
        </div>

        <div class="div"></div>
        <div class="section" style="color:var(--muted)">Savings Target Breakdown</div>
        <div class="trow"><span class="tc">All-in boat purchase</span><span class="tv" id="t-purchase">‚Äî</span></div>
        <div class="trow"><span class="tc">12-month emergency fund</span><span class="tv" id="t-emergency">‚Äî</span></div>
        <div class="trow"><span class="tc">"Oh shit" fund</span><span class="tv">$50,000</span></div>
        <div class="trow total"><span class="tc">Total Target</span><span class="tv" id="t-total">‚Äî</span></div>
        
        <div style="margin-top:14px">
          <div class="prog-meta"><span>Progress to target</span><span id="prog-pct">0%</span></div>
          <div class="prog-bar"><div class="prog-fill" id="prog-fill" style="width:0%;background:var(--accent)"></div></div>
          <div class="prog-sub"><span id="prog-label">$0 of $0</span><span id="prog-gap" style="color:var(--amber)">$0 gap</span></div>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div>
      <!-- Lifestyle Mode -->
      <div class="card">
        <div class="section">Section 2: Lifestyle Mode</div>
        <div class="tabs">
          <button class="tab" onclick="setMode('marina')">üèôÔ∏è Marina Base</button>
          <button class="tab" onclick="setMode('anchor')">‚öì Anchor Base</button>
          <button class="tab on" onclick="setMode('coastal')">üåä Coastal Cruising</button>
          <button class="tab" onclick="setMode('bluewater')">üåç Blue Water Passage</button>
        </div>
        <div class="field">
          <label>Primary Region</label>
          <select id="region-sel" onchange="state.region=this.value;update()">
            <option value="se-asia">SE Asia (√ó0.6)</option>
            <option value="med">Mediterranean off-season (√ó0.85)</option>
            <option value="caribbean" selected>Caribbean (√ó1.15)</option>
            <option value="us">US/EU Coasts (√ó1.75)</option>
            <option value="pacific">Pacific (√ó1.25)</option>
          </select>
        </div>
        <div class="div"></div>
        <div id="budget-rows"></div>
        <div class="btotal">
          <span class="bl">Monthly Total</span>
          <span class="bv" id="monthly-total">‚Äî</span>
        </div>
        <div class="btotal" style="margin-top:6px;padding-top:6px;border-top:1px solid rgba(255,255,255,0.1)">
          <span class="bl">Annual Total</span>
          <span class="bv" id="annual-total" style="font-size:16px">‚Äî</span>
        </div>
        
        <!-- FEATURE 5: SF Cost Offset -->
        <div class="sf-offset">
          <h4>üåÅ What you're escaping (SF costs)</h4>
          <div class="field">
            <label>Current rent/mortgage</label>
            <div class="slider-row">
              <input type="range" id="sf-rent-r" min="2000" max="8000" step="100" value="3200" oninput="updateSFCosts()">
              <input class="num-input" id="sf-rent-i" value="$3,200" style="width:80px">
            </div>
          </div>
          <div class="field">
            <label>Car payment + insurance + gas</label>
            <div class="slider-row">
              <input type="range" id="sf-car-r" min="300" max="1500" step="50" value="800" oninput="updateSFCosts()">
              <input class="num-input" id="sf-car-i" value="$800" style="width:80px">
            </div>
          </div>
          <div class="field">
            <label>CA state income tax rate</label>
            <div class="slider-row">
              <input type="range" id="ca-tax-r" min="0" max="15" step="0.1" value="9.3" oninput="updateSFCosts()">
              <span class="num-input" style="width:70px" id="ca-tax-i">9.3%</span>
            </div>
          </div>
          <div class="div"></div>
          <div class="trow"><span class="tc">Monthly costs eliminated</span><span class="tv" id="sf-costs-eliminated">‚Äî</span></div>
          <div class="trow"><span class="tc">Annual CA tax savings (monthly)</span><span class="tv" id="ca-tax-savings">‚Äî</span></div>
          <div class="trow total"><span class="tc">Total monthly costs eliminated</span><span class="tv" id="total-sf-eliminated">‚Äî</span></div>
          <div style="text-align:center;margin-top:10px;padding:10px;background:rgba(255,255,255,0.03);border-radius:6px;">
            <div style="font-size:13px;font-weight:600;color:var(--accent)" id="net-lifestyle-cost">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- Skills & Life Logistics -->
      <div class="card">
        <div class="section">Section 4: Readiness Checklist</div>
        
        <div class="check-group">
          <h4>Skills (tick what you've completed)</h4>
          <div class="skill-check">
            <input type="checkbox" id="skill-asa104" checked onchange="updateSkills()">
            <label for="skill-asa104">ASA 104 ‚úÖ (you already have this)</label>
          </div>
          <div class="skill-check">
            <input type="checkbox" id="skill-offshore" onchange="updateSkills()">
            <label for="skill-offshore">Offshore passage experience</label>
          </div>
          <div class="skill-check">
            <input type="checkbox" id="skill-liveaboard" onchange="updateSkills()">
            <label for="skill-liveaboard">Long-term liveaboard trial</label>
          </div>
          <div class="skill-check">
            <input type="checkbox" id="skill-systems" onchange="updateSkills()">
            <label for="skill-systems">Boat systems knowledge (diesel, electrical, plumbing)</label>
          </div>
        </div>

        <div class="check-group">
          <h4>Life Logistics</h4>
          <div class="skill-check">
            <input type="checkbox" id="life-bonnie" onchange="updateSkills()">
            <label for="life-bonnie">Bonnie vet/quarantine research done</label>
          </div>
          <div class="skill-check">
            <input type="checkbox" id="life-health" onchange="updateSkills()">
            <label for="life-health">Expat health insurance researched</label>
          </div>
          <div class="skill-check">
            <input type="checkbox" id="life-partner" onchange="updateSkills()">
            <label for="life-partner">Partner situation resolved</label>
          </div>
          <div class="skill-check">
            <input type="checkbox" id="life-parents" onchange="updateSkills()">
            <label for="life-parents">Parents situation stable</label>
          </div>
          <div class="skill-check">
            <input type="checkbox" id="life-ca-domicile" onchange="updateSkills()">
            <label for="life-ca-domicile">CA domicile severance completed (if applicable)</label>
          </div>
        </div>

        <!-- FEATURE 2: Exit / Return Cost Scenario -->
        <div class="collapsible">
          <div class="collapsible-header" onclick="toggleCollapsible('exit')">
            <span style="font-size:12px;color:var(--accent);font-weight:600">üè† What does coming back cost?</span>
            <span class="collapsible-icon" id="exit-icon">‚ñº</span>
          </div>
          <div class="collapsible-content" id="exit-content">
            <div class="field">
              <label>Boat sale estimate</label>
              <div class="slider-row">
                <input type="range" id="boat-sale-r" min="100000" max="400000" step="5000" value="157500" oninput="updateExitScenario()">
                <input class="num-input" id="boat-sale-i" value="$157,500">
              </div>
              <div style="font-size:11px;color:var(--muted);margin-top:4px">
                Default: boat price √ó 70% (IPs hold value well)
              </div>
            </div>
            <div class="field">
              <label>Months of transition expenses</label>
              <div class="slider-row">
                <input type="range" id="transition-months-r" min="1" max="12" step="1" value="3" oninput="updateExitScenario()">
                <span class="num-input" style="width:60px" id="transition-months-i">3</span>
              </div>
            </div>
            <div class="field">
              <label>First/last/deposit on new apartment</label>
              <div class="slider-row">
                <input type="range" id="apartment-cost-r" min="3000" max="20000" step="500" value="8000" oninput="updateExitScenario()">
                <input class="num-input" id="apartment-cost-i" value="$8,000">
              </div>
            </div>
            <div class="field">
              <label>Flights home</label>
              <div class="slider-row">
                <input type="range" id="flights-cost-r" min="500" max="10000" step="250" value="2000" oninput="updateExitScenario()">
                <input class="num-input" id="flights-cost-i" value="$2,000">
              </div>
            </div>
            <div class="div"></div>
            <div class="trow"><span class="tc">Net from boat sale</span><span class="tv" id="net-boat-sale">‚Äî</span></div>
            <div class="trow"><span class="tc">Total re-entry cost</span><span class="tv" id="reentry-cost">‚Äî</span></div>
            <div class="trow total" id="net-exit-row"><span class="tc">Net exit position</span><span class="tv" id="net-exit-position">‚Äî</span></div>
            <div style="text-align:center;margin-top:12px;padding:12px;border-radius:8px" id="exit-summary">
              <div style="font-size:13px;font-weight:600" id="exit-message">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="div"></div>
        <div id="financial-checks"></div>
      </div>
    </div>

    <!-- FULL WIDTH: Timeline -->
    <div class="card full">
      <div class="section">Section 5: Timeline & Summary</div>
      
      <!-- FEATURE 3: Reverse Calculator -->
      <div class="reverse-calc">
        <h4>üéØ "Leave By" Reverse Calculator</h4>
        <div class="field">
          <label>Target departure year</label>
          <select id="target-year" onchange="updateReverseCalculator()">
            <option value="2026">2026</option>
            <option value="2027" selected>2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
            <option value="2031">2031</option>
          </select>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
          <div style="text-align:center">
            <div style="font-size:10px;color:var(--muted);margin-bottom:2px">MONTHS REMAINING</div>
            <div style="font-size:16px;font-weight:700;color:var(--amber)" id="reverse-months-remaining">‚Äî</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:10px;color:var(--muted);margin-bottom:2px">REQUIRED SAVINGS/MONTH</div>
            <div style="font-size:16px;font-weight:700;color:var(--amber)" id="reverse-required-savings">‚Äî</div>
          </div>
        </div>
        <div style="text-align:center;margin-top:12px;padding:10px;border-radius:6px" id="reverse-feasibility">
          <div style="font-size:12px;font-weight:600" id="reverse-message">‚Äî</div>
        </div>
        <div style="text-align:center;margin-top:8px;font-size:12px;color:var(--muted)">
          At your current rate of <span id="current-savings-rate">‚Äî</span>/mo, you'll be ready in <span id="current-ready-date">‚Äî</span>
        </div>
      </div>
      
      <div class="tbox">
        <div class="tbox-item">
          <div class="tlbl">Months to Financially Ready</div>
          <div class="tval" id="tl-months">‚Äî</div>
          <div class="tsub" id="tl-date">‚Äî</div>
        </div>
        <div class="tbox-item">
          <div class="tlbl">Target Date</div>
          <div class="tval" id="tl-target">‚Äî</div>
          <div class="tsub">based on current savings rate</div>
        </div>
        <div class="tbox-item">
          <div class="tlbl">Annual Income Required</div>
          <div class="tval" id="tl-req">‚Äî</div>
          <div class="tsub">gross income (pre-tax)</div>
        </div>
        <div class="tbox-item">
          <div class="tlbl">Income Surplus/Deficit</div>
          <div class="tval" id="tl-delta">‚Äî</div>
          <div class="tsub">vs your current income</div>
        </div>
        <div class="tbox-item">
          <div class="tlbl">Recurring % Needed</div>
          <div class="tval" id="tl-recurring">‚Äî</div>
          <div class="tsub">for sustainability</div>
        </div>
      </div>
    </div>

  </div>
</div>

<footer>
  Built from your real research: financial planner questions, cruiser cost data, boat preferences, and comparison analysis. Updated February 2026.
</footer>

<script>
const state = {
  boat: 'sp-cruiser',
  boatPrice: 225000,
  addons: [
    { id:'survey',       label:'Pre-purchase survey + haul-out',      cost:1200,  on:true },
    { id:'delivery',     label:'Delivery/transport',                 cost:15000, on:true },
    { id:'refit',        label:'Initial refit & repairs',            cost:35000, on:true },
    { id:'electronics',  label:'Electronics upgrades',              cost:15000, on:true },
    { id:'safety',       label:'Safety equipment',                  cost:8000,  on:true },
    { id:'dinghy',       label:'Dinghy & outboard',                 cost:5000,  on:true },
    { id:'tools',        label:'Tools & spare parts',               cost:5000,  on:true },
    { id:'provisioning', label:'Initial provisioning',              cost:3000,  on:true },
    { id:'docs',         label:'Documentation & insurance',         cost:1500,  on:true },
  ],
  mode: 'coastal',
  region: 'caribbean',
  income: 500000,
  recurringPct: 60,
  // FEATURE 1: Balance Sheet
  liquidSavings: 50000,
  brokerage: 50000,
  ira: 50000,
  retirement: 0,
  otherAssets: 0,
  rate: 15000,
  taxRate: 38,
  paymentMethod: 'cash',
  downPaymentPct: 20,
  interestRate: 7.5,
  loanTermYears: 15,
  // FEATURE 4: Concentration Risk
  concentrationPct: 60,
  // FEATURE 5: SF Cost Offset
  sfRent: 3200,
  sfCar: 800,
  caTaxRate: 9.3,
  // FEATURE 6: Resale Value
  yearsSelling: 7,
  retentionRate: 72,
  // FEATURE 2: Exit Scenario
  boatSaleEstimate: 157500,
  transitionMonths: 3,
  apartmentCost: 8000,
  flightsCost: 2000,
  // FEATURE 3: Reverse Calculator
  targetYear: 2027,
};

// Jordan's specific boat options with actual price ranges from research
const BOATS = {
  'sp-cruiser': { min: 199000, max: 254000, name: 'Island Packet SP Cruiser', retention: 72 },
  'ip420':      { min: 180000, max: 280000, name: 'Island Packet 420', retention: 72 },
  'ip440':      { min: 250000, max: 380000, name: 'Island Packet 440', retention: 72 },
  'leopard40':  { min: 200000, max: 350000, name: 'Leopard 40', retention: 60 },
  'custom':     { min: 150000, max: 400000, name: 'Custom', retention: 65 },
};

// Jordan's actual lifestyle modes from the planner, not generic budget/comfortable/luxury
// maintenance and insurance are calculated from boat value, not fixed amounts
const MODES = {
  marina: {
    name: 'üèôÔ∏è Marina Base',
    desc: 'Docked, full amenities',
    marinas: 1500, food: 1200, fuel: 150,
    bonnie: 250, starlink: 165, health: 400, travel: 200, misc: 300
  },
  anchor: {
    name: '‚öì Anchor Base', 
    desc: 'Anchored long-term, occasional marina',
    marinas: 300, food: 1000, fuel: 100,
    bonnie: 250, starlink: 165, health: 400, travel: 200, misc: 250
  },
  coastal: {
    name: 'üåä Coastal Cruising',
    desc: 'Day hops, marinas 1-2x/week', 
    marinas: 700, food: 1300, fuel: 200,
    bonnie: 250, starlink: 165, health: 400, travel: 300, misc: 350
  },
  bluewater: {
    name: 'üåç Blue Water Passage',
    desc: 'Ocean crossings',
    marinas: 400, food: 1400, fuel: 300,
    bonnie: 250, starlink: 165, health: 400, travel: 400, misc: 400
  }
};

// Regional multipliers from research
const MULTS = { 'se-asia':0.6, med:0.85, caribbean:1.15, us:1.75, pacific:1.25 };
const REGION_LBL = { 'se-asia':'SE Asia', med:'Mediterranean', caribbean:'Caribbean', us:'US/EU Coasts', pacific:'Pacific' };

// Fixed costs that don't vary by region (Jordan's specific items)
// maintenance and insurance are calculated from boat value, not in this set
const FIXED_CATS = new Set(['bonnie','starlink','health','travel']);

const CAT_LBL = {
  maintenance:'Boat maintenance (4% of boat value annually)', 
  insurance:'Insurance (2% of boat value annually)',
  marinas:'Marinas/moorings',
  food:'Food & dining', fuel:'Fuel',
  bonnie:'Bonnie (dog) ‚Äî vet, health certs, food', 
  starlink:'Starlink ‚Äî $165/mo default',
  health:'Expat health insurance ‚Äî $400/mo (US citizen abroad)',
  travel:'Travel (flights home)', misc:'Misc',
  loanPayment:'Loan payment'
};

function fmt(n) {
  if (n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
  if (n >= 1e5) return '$' + Math.round(n/1000) + 'K';
  return '$' + Math.round(n).toLocaleString();
}
function fmtFull(n) { return '$' + Math.round(n).toLocaleString(); }
function parseNum(s) { return parseInt(s.replace(/[$,]/g,'')) || 0; }

function selectBoat() {
  const boat = document.getElementById('boat-sel').value;
  state.boat = boat;
  const range = BOATS[boat];
  const midpoint = Math.round((range.min + range.max) / 2);
  
  // Update slider range and default value
  const slider = document.getElementById('boat-r');
  slider.min = range.min;
  slider.max = range.max;
  slider.value = midpoint;
  state.boatPrice = midpoint;
  
  // Update retention rate for boat type
  state.retentionRate = range.retention;
  document.getElementById('retention-rate-r').value = state.retentionRate;
  document.getElementById('retention-rate-i').textContent = state.retentionRate + '%';
  
  // Update default boat sale estimate
  state.boatSaleEstimate = Math.round(midpoint * 0.7);
  document.getElementById('boat-sale-r').value = state.boatSaleEstimate;
  document.getElementById('boat-sale-i').value = fmtFull(state.boatSaleEstimate);
  
  document.getElementById('boat-i').value = fmtFull(midpoint);
  update();
}

// FEATURE 1: Balance Sheet Updates
function updateLiquid() {
  const val = parseInt(document.getElementById('liquid-r').value);
  state.liquidSavings = val;
  document.getElementById('liquid-i').value = fmtFull(val);
  update();
}

function updateBrokerage() {
  const val = parseInt(document.getElementById('brokerage-r').value);
  state.brokerage = val;
  document.getElementById('brokerage-i').value = fmtFull(val);
  update();
}

function updateIRA() {
  const val = parseInt(document.getElementById('ira-r').value);
  state.ira = val;
  document.getElementById('ira-i').value = fmtFull(val);
  document.getElementById('ira-net').textContent = fmtFull(Math.round(val * 0.675));
  update();
}

function updateRetirement() {
  const val = parseInt(document.getElementById('retirement-r').value);
  state.retirement = val;
  document.getElementById('retirement-i').value = fmtFull(val);
  update();
}

function updateOtherAssets() {
  const val = parseInt(document.getElementById('other-assets-r').value);
  state.otherAssets = val;
  document.getElementById('other-assets-i').value = fmtFull(val);
  update();
}

// FEATURE 4: Concentration Risk
function updateConcentration() {
  const val = parseInt(document.getElementById('concentration-r').value);
  state.concentrationPct = val;
  document.getElementById('concentration-i').textContent = val + '%';
  
  const warning = document.getElementById('concentration-warning');
  const scenario = document.getElementById('concentration-scenario');
  
  if (val < 40) {
    warning.className = 'concentration-warning low';
    warning.innerHTML = '‚úÖ <strong>Well diversified</strong>';
    scenario.style.display = 'none';
  } else if (val <= 60) {
    warning.className = 'concentration-warning moderate';
    warning.innerHTML = '‚ö†Ô∏è <strong>Moderate concentration</strong> ‚Äî one client loss = significant income hit';
    scenario.style.display = 'block';
  } else {
    warning.className = 'concentration-warning';
    warning.style.background = 'rgba(224,85,85,0.07)';
    warning.style.borderColor = 'rgba(224,85,85,0.2)';
    warning.innerHTML = '‚ùå <strong>High concentration risk</strong> ‚Äî this is your biggest financial risk for the sailing life. One client departure could strand you mid-passage.';
    scenario.style.display = 'block';
  }
  
  update();
}

// FEATURE 5: SF Cost Offset
function updateSFCosts() {
  state.sfRent = parseInt(document.getElementById('sf-rent-r').value);
  state.sfCar = parseInt(document.getElementById('sf-car-r').value);
  state.caTaxRate = parseFloat(document.getElementById('ca-tax-r').value);
  
  document.getElementById('sf-rent-i').value = '$' + state.sfRent.toLocaleString();
  document.getElementById('sf-car-i').value = '$' + state.sfCar.toLocaleString();
  document.getElementById('ca-tax-i').textContent = state.caTaxRate + '%';
  
  update();
}

// FEATURE 6: Resale Value
function updateYearsSelling() {
  const val = parseInt(document.getElementById('years-selling-r').value);
  state.yearsSelling = val;
  document.getElementById('years-selling-i').textContent = val;
  document.getElementById('resale-years').textContent = val;
  document.getElementById('rent-years').textContent = val;
  update();
}

function updateRetentionRate() {
  const val = parseInt(document.getElementById('retention-rate-r').value);
  state.retentionRate = val;
  document.getElementById('retention-rate-i').textContent = val + '%';
  update();
}

// FEATURE 2: Exit Scenario
function updateExitScenario() {
  state.boatSaleEstimate = parseInt(document.getElementById('boat-sale-r').value);
  state.transitionMonths = parseInt(document.getElementById('transition-months-r').value);
  state.apartmentCost = parseInt(document.getElementById('apartment-cost-r').value);
  state.flightsCost = parseInt(document.getElementById('flights-cost-r').value);
  
  document.getElementById('boat-sale-i').value = fmtFull(state.boatSaleEstimate);
  document.getElementById('transition-months-i').textContent = state.transitionMonths;
  document.getElementById('apartment-cost-i').value = fmtFull(state.apartmentCost);
  document.getElementById('flights-cost-i').value = fmtFull(state.flightsCost);
  
  update();
}

// FEATURE 3: Reverse Calculator
function updateReverseCalculator() {
  state.targetYear = parseInt(document.getElementById('target-year').value);
  update();
}

function toggleCollapsible(id) {
  const content = document.getElementById(id + '-content');
  const icon = document.getElementById(id + '-icon');
  
  if (content.classList.contains('open')) {
    content.classList.remove('open');
    icon.classList.remove('open');
  } else {
    content.classList.add('open');
    icon.classList.add('open');
  }
}

function compute() {
  const addonTotal = state.addons.filter(a=>a.on).reduce((s,a)=>s+a.cost, 0);
  const purchaseTotal = state.boatPrice + addonTotal;

  // FEATURE 1: Use balance sheet instead of single savings figure
  const availableForPurchase = state.liquidSavings + state.brokerage;
  const emergencyBackstop = Math.round(state.ira * 0.675);
  
  // Financing calculations
  const downPayment = state.paymentMethod === 'finance' ? Math.round(purchaseTotal * state.downPaymentPct / 100) : 0;
  const loanAmount = state.paymentMethod === 'finance' ? purchaseTotal - downPayment : 0;
  
  let monthlyLoanPayment = 0;
  let totalInterest = 0;
  
  if (state.paymentMethod === 'finance' && loanAmount > 0) {
    const r = state.interestRate / 100 / 12; // Monthly rate
    const n = state.loanTermYears * 12; // Number of months
    if (r > 0) {
      monthlyLoanPayment = Math.round(loanAmount * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1));
      totalInterest = (monthlyLoanPayment * n) - loanAmount;
    } else {
      monthlyLoanPayment = Math.round(loanAmount / n);
    }
  }

  const mode = MODES[state.mode];
  const mult = MULTS[state.region];
  const isCatamaran = state.boat === 'leopard40';
  
  const monthly = {};
  
  // Calculate maintenance and insurance from boat value
  monthly.maintenance = Math.round((state.boatPrice * 0.04) / 12);
  monthly.insurance = Math.round((state.boatPrice * 0.02) / 12);
  
  // Calculate other categories from mode base values
  for (const [k,v] of Object.entries(mode)) {
    if (k === 'name' || k === 'desc') continue;
    let cost = FIXED_CATS.has(k) ? v : Math.round(v * mult);
    
    // Apply catamaran premiums
    if (isCatamaran) {
      if (k === 'marinas') cost = Math.round(cost * 1.5); // 50% premium for beam charges
      if (k === 'fuel') cost = Math.round(cost * 1.3);    // 30% premium for two engines
    }
    
    monthly[k] = cost;
  }
  
  // Add loan payment to monthly costs when financing
  if (state.paymentMethod === 'finance' && monthlyLoanPayment > 0) {
    monthly.loanPayment = monthlyLoanPayment;
  }
  
  const monthlyTotal = Object.values(monthly).reduce((s,v)=>s+v, 0);
  const annualBudget = monthlyTotal * 12;

  // Calculate savings needed based on payment method - use available funds
  const baseMonthlyForEmergency = Object.entries(monthly)
    .filter(([k,v]) => k !== 'loanPayment')
    .reduce((s,[k,v]) => s+v, 0);
  
  const emergencyFund = baseMonthlyForEmergency * 12;
  const ohShit = 50000;
  
  const savingsNeeded = state.paymentMethod === 'finance' 
    ? downPayment + addonTotal + emergencyFund + ohShit
    : purchaseTotal + emergencyFund + ohShit;
    
  const gap = Math.max(0, savingsNeeded - availableForPurchase);
  const months = state.rate > 0 ? Math.ceil(gap / state.rate) : (gap > 0 ? Infinity : 0);

  // Tax calculations - US citizens pay on worldwide income
  const netRequired = Math.round(annualBudget * 1.3); // Net needed after tax (cruising + 30% buffer)
  const grossRequired = Math.round(netRequired / (1 - state.taxRate / 100)); // Gross needed before tax
  
  const recurringAmt = Math.round(state.income * state.recurringPct / 100);
  const projectAmt = state.income - recurringAmt;
  
  // 50% income drop scenario (after tax)
  const dropIncome = Math.round(state.income * 0.5);
  const dropIncomeAfterTax = dropIncome * (1 - state.taxRate / 100);
  const dropIncomeMonthly = dropIncomeAfterTax / 12;
  const netBurn = Math.max(0, monthlyTotal - dropIncomeMonthly);
  const runwayMonths = netBurn > 0 ? Math.floor(availableForPurchase / netBurn) : 999;
  
  // FEATURE 4: Concentration risk calculations
  const topClientIncome = Math.round(state.income * state.concentrationPct / 100);
  const remainingIncome = state.income - topClientIncome;
  const remainingIncomeAfterTax = remainingIncome * (1 - state.taxRate / 100);
  const remainingIncomeMonthly = remainingIncomeAfterTax / 12;
  const clientLossNetBurn = Math.max(0, monthlyTotal - remainingIncomeMonthly);
  const clientLossRunway = clientLossNetBurn > 0 ? Math.floor(availableForPurchase / clientLossNetBurn) : 999;
  
  // Financial checks - use GROSS income requirement
  const incomeOk = state.income >= grossRequired;
  const boatRatio = state.boatPrice / (state.income || 1);
  const boatOk = boatRatio <= 3.5;
  const coversPurchase = availableForPurchase >= savingsNeeded;
  const coversEmergency = availableForPurchase >= savingsNeeded;
  
  // Recurring income coverage (after tax)
  const recurringAfterTax = recurringAmt * (1 - state.taxRate / 100);
  const recurringCoverage = monthlyTotal > 0 ? (recurringAfterTax / 12) / monthlyTotal : 0;
  const runway6mo = dropIncomeMonthly >= monthlyTotal || runwayMonths >= 6;

  // Comparison calculations - use available funds
  const cashSavingsNeeded = purchaseTotal + emergencyFund + ohShit;
  const financeSavingsNeeded = downPayment + addonTotal + emergencyFund + ohShit;
  const cashGap = Math.max(0, cashSavingsNeeded - availableForPurchase);
  const financeGap = Math.max(0, financeSavingsNeeded - availableForPurchase);
  const cashMonths = state.rate > 0 ? Math.ceil(cashGap / state.rate) : (cashGap > 0 ? Infinity : 0);
  const financeMonths = state.rate > 0 ? Math.ceil(financeGap / state.rate) : (financeGap > 0 ? Infinity : 0);

  // FEATURE 5: SF Cost Offset calculations
  const sfCostsEliminated = state.sfRent + state.sfCar;
  const caTaxSavings = Math.round((state.income * state.caTaxRate / 100) / 12);
  const totalSFEliminated = sfCostsEliminated + caTaxSavings;
  const netLifestyleCost = monthlyTotal - totalSFEliminated;
  
  // FEATURE 6: Resale calculations
  const resaleValue = Math.round(state.boatPrice * Math.pow(state.retentionRate / 100, state.yearsSelling / 10));
  const netBoatCost = purchaseTotal - resaleValue;
  const annualizedBoatCost = Math.round(netBoatCost / state.yearsSelling);
  const rentComparison = 3200 * 12 * state.yearsSelling;
  
  // FEATURE 2: Exit scenario calculations
  const netFromBoatSale = state.boatSaleEstimate - (state.paymentMethod === 'finance' ? Math.max(0, loanAmount - (monthlyLoanPayment * 12 * 2)) : 0); // Rough remaining balance estimate
  const transitionCost = Math.round((monthlyTotal * state.transitionMonths) + state.apartmentCost + state.flightsCost);
  const netExitPosition = netFromBoatSale - transitionCost;
  
  // FEATURE 3: Reverse calculator
  const now = new Date(2026, 1); // Feb 2026
  const targetDate = new Date(state.targetYear, 0); // Jan of target year
  const monthsToTarget = Math.max(0, (targetDate.getFullYear() - now.getFullYear()) * 12 + (targetDate.getMonth() - now.getMonth()));
  const requiredMonthlySavings = monthsToTarget > 0 ? Math.ceil(gap / monthsToTarget) : 0;
  const isReverseFeasible = requiredMonthlySavings <= state.income * 0.3 / 12; // 30% of income max
  
  return {
    addonTotal, purchaseTotal,
    monthly, monthlyTotal, annualBudget,
    emergencyFund, ohShit, target: savingsNeeded, gap, months,
    netRequired, grossRequired, incomeOk, boatRatio, boatOk,
    coversPurchase, coversEmergency,
    recurringAmt, projectAmt, dropIncome, runwayMonths,
    recurringCoverage, runway6mo,
    // Financing specific
    downPayment, loanAmount, monthlyLoanPayment, totalInterest,
    savingsNeeded, cashSavingsNeeded, financeSavingsNeeded,
    cashMonths, financeMonths, baseMonthlyForEmergency,
    // FEATURE 1: Balance sheet
    availableForPurchase, emergencyBackstop,
    // FEATURE 4: Concentration
    topClientIncome, remainingIncome, clientLossRunway,
    // FEATURE 5: SF offset
    sfCostsEliminated, caTaxSavings, totalSFEliminated, netLifestyleCost,
    // FEATURE 6: Resale
    resaleValue, netBoatCost, annualizedBoatCost, rentComparison,
    // FEATURE 2: Exit scenario
    netFromBoatSale, transitionCost, netExitPosition,
    // FEATURE 3: Reverse calculator
    monthsToTarget, requiredMonthlySavings, isReverseFeasible
  };
}

function renderAddons() {
  document.getElementById('addon-list').innerHTML = state.addons.map(a => `
    <label class="addon">
      <div style="display:flex;align-items:center">
        <input type="checkbox" ${a.on?'checked':''} onchange="toggleAddon('${a.id}',this.checked)">
        <span class="aname">${a.label}</span>
      </div>
      <span class="acost">${fmtFull(a.cost)}</span>
    </label>
  `).join('');
}

function toggleAddon(id, val) {
  state.addons.find(a=>a.id===id).on = val;
  update();
}

function setMode(m) {
  state.mode = m;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  document.querySelector(`[onclick="setMode('${m}')"]`).classList.add('on');
  update();
}

function updateSkills() {
  // Just trigger update, skills are checked in the compute phase
  update();
}

function setPaymentMethod(method) {
  state.paymentMethod = method;
  
  // Update tab styling
  document.querySelectorAll('.tabs button').forEach(t => t.classList.remove('on'));
  document.querySelector(`[onclick="setPaymentMethod('${method}')"]`).classList.add('on');
  
  // Show/hide financing inputs and comparison
  const inputs = document.getElementById('financing-inputs');
  const comparison = document.getElementById('finance-comparison');
  
  if (method === 'finance') {
    inputs.style.display = 'block';
    comparison.style.display = 'block';
  } else {
    inputs.style.display = 'none';
    comparison.style.display = 'none';
  }
  
  update();
}

function bindSlider(rangeId, inputId, stateKey, min, max) {
  const r = document.getElementById(rangeId);
  const i = document.getElementById(inputId);
  r.addEventListener('input', () => {
    state[stateKey] = parseInt(r.value);
    if (stateKey === 'recurringPct') {
      i.textContent = state[stateKey] + '%';
    } else {
      i.value = fmtFull(state[stateKey]);
    }
    update();
  });
  if (inputId !== 'recurring-i') {
    i.addEventListener('change', () => {
      const v = Math.max(min, Math.min(max, parseNum(i.value)));
      state[stateKey] = v;
      r.value = v;
      i.value = fmtFull(v);
      update();
    });
  }
}

function update() {
  const d = compute();

  // Summary bar
  document.getElementById('s-purchase').textContent = fmt(d.purchaseTotal);
  document.getElementById('s-monthly').textContent = fmt(d.monthlyTotal);
  document.getElementById('s-gross').textContent = fmt(d.grossRequired);
  
  const tEl = document.getElementById('s-timeline');
  if (d.months === 0) { tEl.textContent = 'Ready!'; tEl.className = 'val g'; }
  else if (d.months === Infinity) { tEl.textContent = '‚àû'; tEl.className = 'val r'; }
  else { tEl.textContent = d.months + ' mo'; tEl.className = 'val ' + (d.months<=12?'g':d.months<=36?'a':'r'); }

  const rEl = document.getElementById('s-recurring');
  if (d.recurringCoverage >= 1.0) { rEl.textContent = 'Covered'; rEl.className = 'val g'; }
  else if (d.recurringCoverage >= 0.8) { rEl.textContent = Math.round(d.recurringCoverage*100) + '%'; rEl.className = 'val a'; }
  else { rEl.textContent = Math.round(d.recurringCoverage*100) + '%'; rEl.className = 'val r'; }

  // Purchase
  document.getElementById('purchase-total').textContent = fmtFull(d.purchaseTotal);

  // Budget rows with special handling for calculated values
  const budgetRowsHtml = Object.entries(d.monthly).map(([k,v]) => {
    let label = CAT_LBL[k];
    let amount = fmtFull(v);
    
    // Show calculation for maintenance and insurance
    if (k === 'maintenance') {
      amount = `${fmtFull(v)} <span style="font-size:10px;color:var(--muted)">(${fmtFull(state.boatPrice)} √ó 4% √∑ 12)</span>`;
    } else if (k === 'insurance') {
      amount = `${fmtFull(v)} <span style="font-size:10px;color:var(--muted)">(${fmtFull(state.boatPrice)} √ó 2% √∑ 12)</span>`;
    }
    
    // Show catamaran premium indicator
    if (state.boat === 'leopard40' && (k === 'marinas' || k === 'fuel')) {
      const premium = k === 'marinas' ? '+50%' : '+30%';
      amount = `${fmtFull(v)} <span style="font-size:10px;color:var(--amber)">(cat ${premium})</span>`;
    }
    
    return `<div class="brow"><span class="bc">${label}</span><span class="ba">${amount}</span></div>`;
  }).join('');
  
  document.getElementById('budget-rows').innerHTML = budgetRowsHtml;
  document.getElementById('monthly-total').textContent = fmtFull(d.monthlyTotal);
  document.getElementById('annual-total').textContent = fmtFull(d.annualBudget);

  // FEATURE 1: Balance sheet updates
  document.getElementById('available-purchase').textContent = fmtFull(d.availableForPurchase);
  document.getElementById('emergency-backstop').textContent = fmtFull(d.emergencyBackstop);
  document.getElementById('ira-net').textContent = fmtFull(d.emergencyBackstop);

  // FEATURE 4: Concentration risk updates
  if (state.concentrationPct > 0) {
    document.getElementById('post-client-loss-income').textContent = fmtFull(d.remainingIncome / 12) + '/mo';
    document.getElementById('client-loss-runway').textContent = d.clientLossRunway + ' months';
  }

  // FEATURE 5: SF Cost Offset updates
  document.getElementById('sf-costs-eliminated').textContent = fmtFull(d.sfCostsEliminated);
  document.getElementById('ca-tax-savings').textContent = fmtFull(d.caTaxSavings);
  document.getElementById('total-sf-eliminated').textContent = fmtFull(d.totalSFEliminated);
  
  const netCostEl = document.getElementById('net-lifestyle-cost');
  if (d.netLifestyleCost < 0) {
    netCostEl.textContent = `Your sailboat lifestyle actually costs ${fmtFull(Math.abs(d.netLifestyleCost))}/mo LESS than SF`;
    netCostEl.style.color = 'var(--green)';
  } else {
    netCostEl.textContent = `Net sailboat lifestyle cost: ${fmtFull(d.netLifestyleCost)}/mo MORE than SF`;
    netCostEl.style.color = 'var(--amber)';
  }

  // FEATURE 6: Resale value updates
  document.getElementById('resale-value').textContent = fmtFull(d.resaleValue);
  document.getElementById('net-boat-cost').textContent = fmtFull(d.netBoatCost);
  document.getElementById('annualized-cost').textContent = fmtFull(d.annualizedBoatCost) + '/yr';
  document.getElementById('rent-comparison').textContent = fmtFull(d.rentComparison);

  // FEATURE 2: Exit scenario updates
  document.getElementById('net-boat-sale').textContent = fmtFull(d.netFromBoatSale);
  document.getElementById('reentry-cost').textContent = fmtFull(d.transitionCost);
  document.getElementById('net-exit-position').textContent = fmtFull(d.netExitPosition);
  
  const exitRow = document.getElementById('net-exit-row');
  const exitSummary = document.getElementById('exit-summary');
  const exitMessage = document.getElementById('exit-message');
  
  if (d.netExitPosition > 0) {
    exitRow.querySelector('.tv').style.color = 'var(--green)';
    exitSummary.style.background = 'rgba(46,204,113,0.07)';
    exitSummary.style.borderColor = 'rgba(46,204,113,0.2)';
    exitMessage.style.color = 'var(--green)';
    exitMessage.textContent = `‚úÖ You come out ahead! Worst case exit: sell boat, pay re-entry costs, end up with ${fmtFull(d.netExitPosition)}. Your IRA backstop adds another ${fmtFull(d.emergencyBackstop)} if needed.`;
  } else if (d.netExitPosition > -20000) {
    exitRow.querySelector('.tv').style.color = 'var(--amber)';
    exitSummary.style.background = 'rgba(240,165,0,0.07)';
    exitSummary.style.borderColor = 'rgba(240,165,0,0.2)';
    exitMessage.style.color = 'var(--amber)';
    exitMessage.textContent = `‚ö†Ô∏è Close call. Worst case exit: you'd be ${fmtFull(Math.abs(d.netExitPosition))} short, but your IRA backstop of ${fmtFull(d.emergencyBackstop)} covers it.`;
  } else {
    exitRow.querySelector('.tv').style.color = 'var(--red)';
    exitSummary.style.background = 'rgba(224,85,85,0.07)';
    exitSummary.style.borderColor = 'rgba(224,85,85,0.2)';
    exitMessage.style.color = 'var(--red)';
    exitMessage.textContent = `‚ùå Risky exit. You'd be ${fmtFull(Math.abs(d.netExitPosition))} short even after selling. Your IRA backstop of ${fmtFull(d.emergencyBackstop)} helps but doesn't fully cover it.`;
  }

  // FEATURE 3: Reverse calculator updates
  document.getElementById('reverse-months-remaining').textContent = d.monthsToTarget;
  document.getElementById('reverse-required-savings').textContent = fmtFull(d.requiredMonthlySavings);
  document.getElementById('current-savings-rate').textContent = fmtFull(state.rate);
  
  const currentReadyDate = new Date(2026, 1 + d.months);
  document.getElementById('current-ready-date').textContent = currentReadyDate.toLocaleDateString('en-US',{month:'short',year:'numeric'});
  
  const feasibilityEl = document.getElementById('reverse-feasibility');
  const reverseMessageEl = document.getElementById('reverse-message');
  
  if (d.gap <= 0) {
    feasibilityEl.style.background = 'rgba(46,204,113,0.1)';
    reverseMessageEl.style.color = 'var(--green)';
    reverseMessageEl.textContent = `‚úÖ You're already ready! Target exceeded by ${fmtFull(Math.abs(d.gap))}`;
  } else if (d.isReverseFeasible) {
    feasibilityEl.style.background = 'rgba(46,204,113,0.1)';
    reverseMessageEl.style.color = 'var(--green)';
    reverseMessageEl.textContent = `‚úÖ Achievable at current income (${Math.round(d.requiredMonthlySavings/(state.income/12)*100)}% of monthly gross)`;
  } else if (d.requiredMonthlySavings <= state.income * 0.5 / 12) {
    feasibilityEl.style.background = 'rgba(240,165,0,0.1)';
    reverseMessageEl.style.color = 'var(--amber)';
    reverseMessageEl.textContent = `‚ö†Ô∏è Tight but possible (${Math.round(d.requiredMonthlySavings/(state.income/12)*100)}% of monthly gross)`;
  } else {
    feasibilityEl.style.background = 'rgba(224,85,85,0.1)';
    reverseMessageEl.style.color = 'var(--red)';
    reverseMessageEl.textContent = `‚ùå Requires income increase (need ${Math.round(d.requiredMonthlySavings/(state.income/12)*100)}% of monthly gross)`;
  }

  // Your numbers
  document.getElementById('t-purchase').textContent = state.paymentMethod === 'finance' ? fmtFull(d.downPayment + d.addonTotal) : fmtFull(d.purchaseTotal);
  document.getElementById('t-emergency').textContent = fmtFull(d.emergencyFund);
  document.getElementById('t-total').textContent = fmtFull(d.savingsNeeded);

  document.getElementById('recurring-amt').textContent = fmtFull(d.recurringAmt);
  document.getElementById('project-amt').textContent = fmtFull(d.projectAmt);
  document.getElementById('drop-income').textContent = fmtFull(d.dropIncome) + '/yr';
  document.getElementById('runway-months').textContent = d.runwayMonths + ' months';

  const pct = Math.min(100, Math.round((d.availableForPurchase / d.savingsNeeded) * 100));
  document.getElementById('prog-pct').textContent = pct + '%';
  const fill = document.getElementById('prog-fill');
  fill.style.width = pct + '%';
  fill.style.background = pct >= 100 ? 'var(--green)' : pct >= 60 ? 'var(--amber)' : 'var(--accent)';
  document.getElementById('prog-label').textContent = `${fmtFull(d.availableForPurchase)} of ${fmtFull(d.savingsNeeded)}`;
  const gapEl = document.getElementById('prog-gap');
  if (d.gap <= 0) { gapEl.textContent = '‚úì Target met!'; gapEl.style.color = 'var(--green)'; }
  else { gapEl.textContent = fmtFull(d.gap) + ' gap'; gapEl.style.color = 'var(--amber)'; }

  // Financial checks - use gross requirements
  const checks = [
    {
      ok: d.incomeOk, warn: state.income >= d.netRequired && !d.incomeOk,
      title: 'Gross income covers cruising costs + buffer + taxes',
      detail: d.incomeOk
        ? `‚úì Your ${fmtFull(state.income)}/yr exceeds ${fmtFull(d.grossRequired)}/yr gross requirement (${fmtFull(d.netRequired)} net + ${state.taxRate}% tax)`
        : `Need ${fmtFull(d.grossRequired)}/yr gross (${fmtFull(d.netRequired)} net + ${state.taxRate}% tax) ‚Äî you're ${fmtFull(d.grossRequired - state.income)} short`,
    },
    {
      ok: d.boatOk, warn: d.boatRatio > 3.5 && d.boatRatio <= 5,
      title: 'Boat price ‚â§ 3.5√ó annual income',
      detail: d.boatOk
        ? `‚úì Boat is ${d.boatRatio.toFixed(1)}√ó your income ‚Äî within safe range`
        : `Boat is ${d.boatRatio.toFixed(1)}√ó income ‚Äî recommend under 3.5√ó`,
    },
    {
      ok: d.coversPurchase, warn: !d.coversPurchase && d.availableForPurchase >= state.boatPrice,
      title: state.paymentMethod === 'finance' ? 'Available funds cover down payment + expenses' : 'Available funds cover all-in purchase',
      detail: d.coversPurchase
        ? (state.paymentMethod === 'finance' 
            ? `‚úì ${fmtFull(d.availableForPurchase)} covers ${fmtFull(d.downPayment + d.addonTotal)} down payment + expenses`
            : `‚úì ${fmtFull(d.availableForPurchase)} covers ${fmtFull(d.purchaseTotal)} all-in`)
        : (state.paymentMethod === 'finance' 
            ? `Need ${fmtFull(d.savingsNeeded - d.availableForPurchase)} more for down payment + expenses`
            : `Need ${fmtFull(d.purchaseTotal - d.availableForPurchase)} more for all-in cost`),
    },
    {
      ok: d.coversEmergency, warn: d.coversPurchase && !d.coversEmergency,
      title: '12-month emergency fund on top of purchase',
      detail: d.coversEmergency
        ? `‚úì Available funds cover purchase + ${fmtFull(d.emergencyFund)} emergency fund`
        : `After purchase, you'd need ${fmtFull(d.emergencyFund)} emergency fund`,
    },
    {
      ok: d.recurringCoverage >= 1.0, warn: d.recurringCoverage >= 0.8,
      title: 'Recurring income alone covers cruising budget (after tax)',
      detail: `${Math.round(d.recurringCoverage*100)}% coverage ‚Äî ${fmtFull(d.recurringAmt/12)}/mo recurring √ó ${100-state.taxRate}% after tax = ${fmtFull((d.recurringAmt * (1-state.taxRate/100))/12)}/mo vs ${fmtFull(d.monthlyTotal)}/mo needed`,
    },
    {
      ok: d.runway6mo, warn: d.runwayMonths >= 3,
      title: '6+ month runway if income drops 50%',
      detail: `At 50% income (${fmtFull(d.dropIncome)}/yr gross), you'd have ${d.runwayMonths} months runway using available funds`,
    }
  ];
  
  document.getElementById('financial-checks').innerHTML = checks.map(c => {
    const cls = c.ok ? 'p' : c.warn ? 'w' : 'f';
    const icon = c.ok ? '‚úÖ' : c.warn ? '‚ö†Ô∏è' : '‚ùå';
    return `<div class="check ${cls}"><span class="check-icon">${icon}</span><div><div class="check-title">${c.title}</div><div class="check-detail">${c.detail}</div></div></div>`;
  }).join('');

  // Timeline
  if (d.months === 0) {
    document.getElementById('tl-months').textContent = 'Ready Now!';
    document.getElementById('tl-date').textContent = 'Target already met';
    document.getElementById('tl-target').textContent = 'üéâ';
  } else if (d.months === Infinity) {
    document.getElementById('tl-months').textContent = '‚àû';
    document.getElementById('tl-date').textContent = 'Set savings rate';
    document.getElementById('tl-target').textContent = '‚Äî';
  } else {
    const now = new Date();
    const then = new Date(now.getFullYear(), now.getMonth() + d.months, 1);
    document.getElementById('tl-months').textContent = d.months;
    document.getElementById('tl-date').textContent = 'at current rate';
    document.getElementById('tl-target').textContent = then.toLocaleDateString('en-US',{month:'short',year:'numeric'});
  }
  
  document.getElementById('tl-req').textContent = fmtFull(d.grossRequired);
  const incDelta = state.income - d.grossRequired;
  const tld = document.getElementById('tl-delta');
  tld.textContent = (incDelta >= 0 ? '+' : '') + fmtFull(incDelta);
  tld.style.color = incDelta >= 0 ? 'var(--green)' : 'var(--red)';
  
  const recReq = Math.round((d.grossRequired) / (state.income || 1) * 100);
  document.getElementById('tl-recurring').textContent = recReq + '%';

  // Financing comparison updates
  if (state.paymentMethod === 'finance' || document.getElementById('finance-comparison').style.display !== 'none') {
    // Update monthly payment
    if (d.monthlyLoanPayment) {
      document.getElementById('monthly-payment').textContent = fmtFull(d.monthlyLoanPayment);
    }

    // Cash scenario
    const cashMonthlyBurn = d.baseMonthlyForEmergency;
    document.getElementById('cash-savings-needed').textContent = fmtFull(d.cashSavingsNeeded);
    document.getElementById('cash-monthly-burn').textContent = fmtFull(cashMonthlyBurn);
    document.getElementById('cash-months-ready').textContent = d.cashMonths === 0 ? 'Ready!' : (d.cashMonths === Infinity ? '‚àû' : d.cashMonths + ' mo');
    document.getElementById('cash-total-cost').textContent = fmtFull(d.purchaseTotal);

    // Finance scenario  
    const financeMonthlyBurn = d.monthlyTotal;
    document.getElementById('finance-savings-needed').textContent = fmtFull(d.financeSavingsNeeded);
    document.getElementById('finance-monthly-burn').textContent = fmtFull(financeMonthlyBurn);
    document.getElementById('finance-months-ready').textContent = d.financeMonths === 0 ? 'Ready!' : (d.financeMonths === Infinity ? '‚àû' : d.financeMonths + ' mo');
    document.getElementById('finance-total-cost').textContent = fmtFull(d.purchaseTotal + d.totalInterest);
    document.getElementById('finance-interest-paid').textContent = fmtFull(d.totalInterest);

    // Key insight
    const insightEl = document.getElementById('insight-text');
    if (d.financeMonths < d.cashMonths && d.financeMonths !== Infinity && d.cashMonths !== Infinity) {
      const monthsSaved = d.cashMonths - d.financeMonths;
      insightEl.textContent = `Financing gets you on the water ${monthsSaved} months sooner, costs ${fmtFull(d.totalInterest)} extra in interest over ${state.loanTermYears} years`;
      insightEl.parentElement.style.borderColor = 'rgba(46,204,113,0.3)';
      insightEl.parentElement.style.background = 'rgba(46,204,113,0.1)';
      insightEl.style.color = 'var(--green)';
    } else if (d.cashMonths < d.financeMonths && d.financeMonths !== Infinity && d.cashMonths !== Infinity) {
      const monthsSaved = d.financeMonths - d.cashMonths;
      insightEl.textContent = `Paying cash gets you there ${monthsSaved} months sooner and saves ${fmtFull(d.totalInterest)} in interest`;
      insightEl.parentElement.style.borderColor = 'rgba(59,157,232,0.3)';
      insightEl.parentElement.style.background = 'rgba(59,157,232,0.1)';
      insightEl.style.color = 'var(--accent)';
    } else if (d.cashMonths === d.financeMonths) {
      insightEl.textContent = `Both paths get you ready at the same time. Cash saves ${fmtFull(d.totalInterest)} in interest.`;
      insightEl.parentElement.style.borderColor = 'rgba(240,165,0,0.3)';
      insightEl.parentElement.style.background = 'rgba(240,165,0,0.1)';
      insightEl.style.color = 'var(--amber)';
    } else {
      insightEl.textContent = 'Set a realistic savings rate to compare paths';
      insightEl.parentElement.style.borderColor = 'rgba(240,165,0,0.3)';
      insightEl.parentElement.style.background = 'rgba(240,165,0,0.1)';
      insightEl.style.color = 'var(--amber)';
    }
  }
}

// Bind financing sliders
function bindFinancingSliders() {
  const downR = document.getElementById('down-r');
  const downI = document.getElementById('down-i');
  downR.addEventListener('input', () => {
    state.downPaymentPct = parseInt(downR.value);
    downI.textContent = state.downPaymentPct + '%';
    update();
  });
  
  const rateR = document.getElementById('rate-interest-r');
  const rateI = document.getElementById('rate-interest-i');
  rateR.addEventListener('input', () => {
    state.interestRate = parseFloat(rateR.value);
    rateI.textContent = state.interestRate + '%';
    update();
  });
}

// Init
renderAddons();
bindSlider('boat-r', 'boat-i', 'boatPrice', 150000, 400000);
bindSlider('income-r', 'income-i', 'income', 100000, 2000000);
bindSlider('recurring-r', 'recurring-i', 'recurringPct', 0, 100);
bindSlider('rate-r', 'rate-i', 'rate', 0, 50000);
bindSlider('tax-r', 'tax-i', 'taxRate', 15, 50);
bindFinancingSliders();

// Initialize all feature-specific elements
updateConcentration();
updateSFCosts();
updateYearsSelling();
updateRetentionRate();
updateExitScenario();
updateReverseCalculator();
updateLiquid();
updateBrokerage();
updateIRA();
updateRetirement();
updateOtherAssets();

// Set initial boat selection
selectBoat();
update();
</script>
</body>
</html>